import React, { useState, useEffect } from "react";
import {
  Play,
  Code,
  Eye,
  Download,
  Settings,
  Cpu,
  Globe,
  Monitor,
  Smartphone,
  Moon,
  Sun,
  Loader2,
  Copy,
  Save,
  AlertCircle,
  Terminal,
  Zap,
  CornerDownRight,
  X,
  Trash2,
} from "lucide-react";

const AgencyDashboard = () => {
  // --------------------------------------------------
  // STATE
  // --------------------------------------------------
  const [apiKeys, setApiKeys] = useState({
    gemini: "",
    openai: "",
    groq: "",
  });

  const [selectedProvider, setSelectedProvider] = useState("gemini");
  const [selectedModel, setSelectedModel] = useState("gemini-1.5-flash");

  const [prompt, setPrompt] = useState("");
  const [generatedCode, setGeneratedCode] = useState("");
  const [loading, setLoading] = useState(false);
  const [view, setView] = useState("preview");
  const [deviceView, setDeviceView] = useState("desktop");
  const [theme, setTheme] = useState("dark");
  const [showSettings, setShowSettings] = useState(false);
  const [history, setHistory] = useState([]);
  const [statusMsg, setStatusMsg] = useState("");

  // --------------------------------------------------
  // CONSTANTS
  // --------------------------------------------------
  const MODELS = {
    gemini: [
      { id: "gemini-1.5-flash", name: "Gemini 1.5 Flash (Fast & Cost-Effective)" },
      { id: "gemini-1.5-pro", name: "Gemini 1.5 Pro (Highest Quality)" },
    ],
    openai: [
      { id: "gpt-4o", name: "GPT-4o (Best Quality)" },
      { id: "gpt-4o-mini", name: "GPT-4o Mini (Fast & Cheap)" },
      { id: "gpt-3.5-turbo", name: "GPT-3.5 Turbo (Legacy)" },
    ],
    groq: [
      { id: "llama3-70b-8192", name: "Llama 3 70B (Open Source Power)" },
      { id: "mixtral-8x7b-32768", name: "Mixtral 8x7B (Long Context)" },
    ],
  };

  const SYSTEM_PROMPT = `
You are an expert AI Web Developer for a high-end agency. 
Generate a COMPLETE, production-ready, single-file HTML website.
Rules:
- RETURN ONLY HTML CODE (no backticks or explanations)
- Must be valid HTML5 + full CSS + JS included
- Use Tailwind CDN & FontAwesome
- Modern, responsive, visually stunning
- Use Unsplash images: https://source.unsplash.com/random/800x600/?keyword
- All interactive elements must function
- Do NOT use alert()
`;

  // --------------------------------------------------
  // LOCAL STORAGE INITIALIZATION
  // --------------------------------------------------
  useEffect(() => {
    const savedKeys = localStorage.getItem("agency_api_keys");
    const savedHistory = localStorage.getItem("agency_history");
    const savedTheme = localStorage.getItem("agency_theme");
    const savedProvider = localStorage.getItem("agency_provider");

    if (savedKeys) setApiKeys(JSON.parse(savedKeys));
    if (savedHistory) setHistory(JSON.parse(savedHistory));
    if (savedTheme) setTheme(savedTheme);

    const provider = savedProvider || "gemini";
    setSelectedProvider(provider);
    setSelectedModel(MODELS[provider][0].id);
  }, []);

  useEffect(() => {
    localStorage.setItem("agency_theme", theme);
  }, [theme]);

  useEffect(() => {
    const newModel = MODELS[selectedProvider][0].id;
    setSelectedModel(newModel);
    localStorage.setItem("agency_provider", selectedProvider);
  }, [selectedProvider]);

  // --------------------------------------------------
  // HELPERS
  // --------------------------------------------------
  const saveKeys = () => {
    localStorage.setItem("agency_api_keys", JSON.stringify(apiKeys));
    setStatusMsg("API Keys Saved!");
    setTimeout(() => setStatusMsg(""), 1500);
  };

  const cleanOutput = (text) =>
    text.replace(/```html|```/g, "").trim();

  const handleInputChange = (provider, value) => {
    setApiKeys((prev) => ({ ...prev, [provider]: value }));
  };

  // --------------------------------------------------
  // API FUNCTIONS
  // --------------------------------------------------
  const generateWithGemini = async () => {
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKeys.gemini}`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: [{ parts: [{ text: `${SYSTEM_PROMPT}\n\n${prompt}` }] }],
        }),
      }
    );
    const data = await response.json();
    if (data.error) throw new Error(data.error.message);
    return cleanOutput(data.candidates[0].content.parts[0].text);
  };

  const generateWithOpenAI = async () => {
    const response = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${apiKeys.openai}`,
      },
      body: JSON.stringify({
        model: selectedModel,
        messages: [
          { role: "system", content: SYSTEM_PROMPT },
          { role: "user", content: prompt },
        ],
        temperature: 0.7,
      }),
    });

    const data = await response.json();
    if (data.error) throw new Error(data.error.message);
    return cleanOutput(data.choices[0].message.content);
  };

  const generateWithGroq = async () => {
    const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${apiKeys.groq}`,
      },
      body: JSON.stringify({
        model: selectedModel,
        messages: [
          { role: "system", content: SYSTEM_PROMPT },
          { role: "user", content: prompt },
        ],
        temperature: 0.7,
      }),
    });

    const data = await response.json();
    if (data.error) throw new Error(data.error.message);
    return cleanOutput(data.choices[0].message.content);
  };

  const handleGenerate = async () => {
    if (!apiKeys[selectedProvider]) {
      setStatusMsg(`Error: Enter your ${selectedProvider.toUpperCase()} API Key.`);
      setShowSettings(true);
      return;
    }
    if (!prompt) {
      setStatusMsg("Error: Enter a project brief.");
      return;
    }

    setLoading(true);
    setGeneratedCode("");
    setView("preview");
    setStatusMsg(`Generating with ${selectedModel}...`);

    try {
      const generators = {
        gemini: generateWithGemini,
        openai: generateWithOpenAI,
        groq: generateWithGroq,
      };
      const code = await generators[selectedProvider]();

      setGeneratedCode(code);

      const newHistory = [
        {
          id: Date.now(),
          prompt,
          code,
          model: selectedModel,
          provider: selectedProvider,
          date: new Date().toLocaleString(),
        },
        ...history,
      ].slice(0, 20);

      setHistory(newHistory);
      localStorage.setItem("agency_history", JSON.stringify(newHistory));

      setStatusMsg("Done!");
    } catch (err) {
      console.error(err);
      setGeneratedCode(`<!-- Error: ${err.message} -->`);
      setStatusMsg("Error generating website.");
    }

    setLoading(false);
    setTimeout(() => setStatusMsg(""), 3000);
  };

  const downloadCode = () => {
    const blob = new Blob([generatedCode], { type: "text/html" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `client_site_${Date.now()}.html`;
    a.click();
    setStatusMsg("Downloaded!");
  };

  const loadFromHistory = (item) => {
    setPrompt(item.prompt);
    setGeneratedCode(item.code);
    setSelectedProvider(item.provider);
    setSelectedModel(item.model);
    setStatusMsg(`Loaded (${item.date})`);
  };

  const removeHistoryItem = (id) => {
    const updated = history.filter((h) => h.id !== id);
    setHistory(updated);
    localStorage.setItem("agency_history", JSON.stringify(updated));
    setStatusMsg("Removed");
  };

  // --------------------------------------------------
  // MODEL SELECTOR
  // --------------------------------------------------
  const ModelSelector = ({ provider }) => (
    <select
      value={selectedModel}
      onChange={(e) => setSelectedModel(e.target.value)}
      className={`w-full p-2 text-sm rounded-lg border ${
        theme === "dark"
          ? "bg-slate-800 border-slate-700"
          : "bg-white border-gray-200"
      }`}
    >
      {MODELS[provider].map((m) => (
        <option key={m.id} value={m.id}>
          {m.name}
        </option>
      ))}
    </select>
  );

  // --------------------------------------------------
  // UI
  // --------------------------------------------------
  return (
    <div
      className={`min-h-screen flex flex-col ${
        theme === "dark"
          ? "bg-slate-950 text-slate-100"
          : "bg-gray-50 text-slate-900"
      }`}
    >
      {/* ------------------------------------------
          HEADER 
        ------------------------------------------ */}
      <header
        className={`px-6 py-4 border-b flex items-center justify-between sticky top-0 backdrop-blur-md ${
          theme === "dark"
            ? "bg-slate-900/80 border-slate-800"
            : "bg-white/70 border-gray-200"
        }`}
      >
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-lg flex items-center justify-center shadow-lg">
            <Cpu className="text-white w-5 h-5" />
          </div>
          <div>
            <h1 className="text-xl font-bold tracking-tight">
              Agent<span className="text-blue-500">Forge</span>
            </h1>
            <span className="text-[10px] uppercase opacity-50 tracking-widest">
              AI Agency Studio
            </span>
          </div>
        </div>

        <div className="flex items-center gap-4">
          {statusMsg && (
            <div
              className={`flex items-center gap-2 px-3 py-1 rounded-full text-xs font-semibold ${
                statusMsg.startsWith("Error")
                  ? "text-red-500"
                  : "text-emerald-500"
              }`}
            >
              {statusMsg.startsWith("Error") ? (
                <AlertCircle size={14} />
              ) : (
                <Zap size={14} />
              )}
              <span>{statusMsg}</span>
            </div>
          )}

          <button
            onClick={() => setTheme(theme === "dark" ? "light" : "dark")}
            className="p-2 rounded-full hover:bg-slate-800/30"
          >
            {theme === "dark" ? <Sun size={18} /> : <Moon size={18} />}
          </button>

          <button
            onClick={() => setShowSettings(!showSettings)}
            className={`px-3 py-2 rounded-lg text-sm flex gap-2 items-center ${
              showSettings
                ? "bg-blue-600 text-white"
                : theme === "dark"
                ? "bg-slate-800 text-slate-300"
                : "bg-white border border-gray-200"
            }`}
          >
            <Settings size={16} />
            <span className="hidden sm:inline">Settings</span>
          </button>
        </div>
      </header>

      {/* ------------------------------------------
          MAIN LAYOUT
        ------------------------------------------ */}
      <div className="flex flex-1 overflow-hidden">
        {/* ------------------------------------------
            SIDEBAR
          ------------------------------------------ */}
        <aside
          className={`w-full max-w-[360px] border-r overflow-y-auto ${
            theme === "dark"
              ? "bg-slate-900 border-slate-800"
              : "bg-white border-gray-200"
          }`}
        >
          <div className="p-5 space-y-6">
            {/* SETTINGS */}
            {showSettings && (
              <div
                className={`p-4 rounded-xl border shadow ${
                  theme === "dark"
                    ? "bg-slate-800 border-slate-700"
                    : "bg-blue-50 border-blue-100"
                }`}
              >
                <h3 className="text-xs uppercase font-bold opacity-60 mb-3 flex gap-2 items-center">
                  <Terminal size={12} /> API Keys
                </h3>

                {Object.keys(apiKeys).map((provider) => (
                  <div key={provider}>
                    <label className="text-[10px] uppercase opacity-60 font-semibold">
                      {provider.toUpperCase()} Key
                    </label>
                    <input
                      type="password"
                      value={apiKeys[provider]}
                      onChange={(e) =>
                        handleInputChange(provider, e.target.value)
                      }
                      className={`w-full p-2 mt-1 text-xs rounded-lg border outline-none ${
                        theme === "dark"
                          ? "bg-slate-900 border-slate-700"
                          : "bg-white border-gray-200"
                      }`}
                      placeholder={`Enter ${provider} key...`}
                    />
                  </div>
                ))}

                <button
                  onClick={saveKeys}
                  className="w-full py-2 mt-3 bg-blue-600 text-white rounded-lg text-xs font-bold"
                >
                  <Save size={12} className="inline mr-1" /> Save Keys
                </button>
                <button
                  onClick={() => setShowSettings(false)}
                  className="w-full text-xs mt-2 opacity-70 hover:opacity-100"
                >
                  <X size={12} className="inline mr-1" /> Close
                </button>
              </div>
            )}

            {/* PROVIDER + MODEL */}
            <div>
              <label className="text-xs uppercase font-bold opacity-60">
                Provider
              </label>
              <div className="flex p-1 rounded-xl mt-1 bg-slate-200/40 dark:bg-slate-800">
                {["gemini", "openai", "groq"].map((p) => (
                  <button
                    key={p}
                    onClick={() => setSelectedProvider(p)}
                    className={`flex-1 py-2 rounded-lg font-semibold text-sm ${
                      selectedProvider === p
                        ? "bg-white dark:bg-slate-700 text-blue-500 shadow"
                        : "opacity-50 hover:opacity-100"
                    }`}
                  >
                    {p}
                  </button>
                ))}
              </div>

              <label className="text-xs uppercase font-bold opacity-60 mt-4 block">
                Model
              </label>
              <ModelSelector provider={selectedProvider} />
            </div>

            {/* PROMPT */}
            <div>
              <label className="text-xs uppercase font-bold opacity-60 flex gap-2 items-center mb-2">
                <Globe size={12} /> Project Brief
              </label>
              <textarea
                value={prompt}
                onChange={(e) => setPrompt(e.target.value)}
                className={`w-full h-40 p-3 rounded-xl border text-sm outline-none resize-none ${
                  theme === "dark"
                    ? "bg-slate-800 border-slate-700"
                    : "bg-white border-gray-200"
                }`}
                placeholder="Describe the client's website..."
              />
            </div>

            {/* GENERATE BUTTON */}
            <button
              onClick={handleGenerate}
              disabled={loading || !prompt || !apiKeys[selectedProvider]}
              className={`w-full py-4 rounded-xl text-white font-bold flex items-center justify-center gap-2 ${
                loading
                  ? "bg-slate-700"
                  : "bg-gradient-to-r from-blue-600 to-indigo-600 hover:opacity-90 shadow-lg"
              }`}
            >
              {loading ? (
                <Loader2 className="animate-spin" size={20} />
              ) : (
                <Play size={18} />
              )}
              {loading ? "Generating..." : "Generate Website"}
            </button>

            {/* HISTORY */}
            {history.length > 0 && (
              <div className="pt-4 border-t dark:border-slate-700">
                <h3 className="text-xs uppercase opacity-60 mb-3">
                  Recent Projects
                </h3>

                <div className="space-y-2 max-h-48 overflow-y-auto pr-2">
                  {history.map((item) => (
                    <div
                      key={item.id}
                      className="flex justify-between items-center p-2 rounded-lg border dark:border-slate-700 hover:bg-slate-800/40 transition cursor-pointer"
                    >
                      <button
                        onClick={() => loadFromHistory(item)}
                        className="flex-1 text-left flex items-center gap-2"
                      >
                        <CornerDownRight size={14} className="text-blue-500" />
                        <span className="truncate">{item.prompt}</span>
                      </button>

                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          removeHistoryItem(item.id);
                        }}
                        className="text-red-400 hover:text-red-600"
                      >
                        <Trash2 size={14} />
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        </aside>

        {/* ------------------------------------------
            PREVIEW PANEL
          ------------------------------------------ */}
        <div
          className={`flex-1 flex flex-col overflow-hidden ${
            theme === "dark" ? "bg-slate-950" : "bg-gray-100"
          }`}
        >
          {/* TOOLBAR */}
          <div
            className={`h-14 border-b flex items-center justify-between px-4 ${
              theme === "dark"
                ? "bg-slate-900 border-slate-800"
                : "bg-white border-gray-200"
            }`}
          >
            <div className="flex bg-slate-200/50 dark:bg-slate-800/50 rounded-lg p-1">
              <button
                onClick={() => setView("preview")}
                className={`px-3 py-1.5 rounded-md text-xs font-bold flex gap-2 ${
                  view === "preview"
                    ? "bg-white dark:bg-slate-700 text-blue-500 shadow"
                    : "opacity-60"
                }`}
              >
                <Eye size={14} /> Preview
              </button>
              <button
                onClick={() => setView("code")}
                className={`px-3 py-1.5 rounded-md text-xs font-bold flex gap-2 ${
                  view === "code"
                    ? "bg-white dark:bg-slate-700 text-blue-500 shadow"
                    : "opacity-60"
                }`}
              >
                <Code size={14} /> Source
              </button>
            </div>

            {view === "preview" && (
              <div className="flex gap-2">
                <button
                  onClick={() => setDeviceView("desktop")}
                  className={`p-2 rounded-md ${
                    deviceView === "desktop"
                      ? "text-blue-500 bg-blue-500/10"
                      : "opacity-50"
                  }`}
                >
                  <Monitor size={18} />
                </button>
                <button
                  onClick={() => setDeviceView("mobile")}
                  className={`p-2 rounded-md ${
                    deviceView === "mobile"
                      ? "text-blue-500 bg-blue-500/10"
                      : "opacity-50"
                  }`}
                >
                  <Smartphone size={18} />
                </button>
              </div>
            )}

            {generatedCode && (
              <div className="flex gap-2">
                <button
                  onClick={() => {
                    navigator.clipboard.writeText(generatedCode);
                    setStatusMsg("Copied!");
                  }}
                  className="p-2 rounded-md border dark:border-slate-700"
                >
                  <Copy size={16} />
                </button>

                <button
                  onClick={downloadCode}
                  className="px-4 py-2 rounded-lg text-sm font-bold bg-emerald-600 text-white hover:bg-emerald-500"
                >
                  <Download size={16} />
                  <span className="hidden sm:inline ml-1">Export</span>
                </button>
              </div>
            )}
          </div>

          {/* PREVIEW OR CODE DISPLAY */}
          <div className="flex-1 flex items-center justify-center p-4">
            {!generatedCode ? (
              <div className="opacity-40 text-center max-w-xs">
                <div className="w-24 h-24 rounded-full bg-slate-800/50 flex items-center justify-center mx-auto mb-4">
                  <Cpu className="w-10 h-10" />
                </div>
                <h2 className="text-xl font-bold">Ready to Forge</h2>
                <p className="text-sm mt-1">
                  Enter API keys + project brief to generate your website.
                </p>
              </div>
            ) : view === "preview" ? (
              <div
                className={`shadow-2xl overflow-hidden ${
                  deviceView === "mobile"
                    ? "w-[375px] h-[700px] rounded-3xl border-8 border-slate-800"
                    : "w-full h-full rounded-xl border border-slate-700"
                }`}
              >
                <iframe
                  title="preview"
                  srcDoc={generatedCode}
                  sandbox="allow-scripts allow-forms"
                  className="w-full h-full"
                />
              </div>
            ) : (
              <textarea
                readOnly
                value={generatedCode}
                className={`w-full h-full p-4 font-mono text-sm rounded-xl border resize-none ${
                  theme === "dark"
                    ? "bg-[#1e1e1e] text-blue-100 border-slate-700"
                    : "bg-white text-slate-900 border-gray-300"
                }`}
              />
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

export default AgencyDashboard;
      
